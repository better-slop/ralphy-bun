Goal
- Convert /home/user/.library-catalog/shell/michaelshimeles.ralphy into a Bun CLI using yargs with full flag parity, preserving behavior for Claude/OpenCode/Cursor/Codex/Qwen/Droid.
- Implement a client-server architecture where the CLI spawns a local REST server per run (default), enabling future UI clients.
- Produce a compiled binary via `bun build --compile`.

Decisions (confirmed)
- Runtime: CLI spawns server per run (single-process) and exits after completion.
- API: REST JSON.
- Agents: external binaries preserved (shell out to agent CLIs).
- Packaging: compiled binary.
- Tests: create new tests (no existing tests to preserve).

Spec (functional + architecture)
- CLI behavior parity
  - Modes: `--init`, `--config`, `--add-rule`, positional single-task (brownfield), PRD loop (default), `--help`, `--version`.
  - Flag parity (yargs):
    - Workflow: `--no-tests|--skip-tests`, `--no-lint|--skip-lint`, `--fast`, `--dry-run`, `--max-iterations`, `--max-retries`, `--retry-delay`.
    - Engine: `--claude` (default), `--opencode`, `--cursor|--agent`, `--codex`, `--qwen`, `--droid`.
    - Parallel: `--parallel`, `--max-parallel`.
    - Git/PR: `--branch-per-task`, `--base-branch`, `--create-pr`, `--draft-pr`, `--no-commit`.
    - PRD source: `--prd`, `--yaml`, `--github`, `--github-label`.
    - Verbose: `-v|--verbose`.
  - Positional text concatenation for single-task mode.
  - Exit codes and early-exit handling consistent with shell script.
- Files and state
  - `.ralphy/config.yaml`, `.ralphy/progress.txt`, `PRD.md`, `tasks.yaml` preserved.
  - Shell behaviors to mirror: config init overwrite prompt, markdown task matching, YAML `tasks[]` with `completed` and `parallel_group`, GitHub issues task source, progress logging format, cost/token accounting, cleanup on SIGINT/SIGTERM.
- Core modules (Bun)
  - `src/cli.ts`: yargs parsing, default command, server spawn, request dispatch.
  - `src/server/index.ts`: Bun.serve REST API (single run) with lifecycle control.
  - `src/core/*`: config IO, task sources, prompt builders, agent runners, git workflows, parallel worktrees, progress tracker, notifier, retry logic, cost tracking.
  - `src/shared/types.ts`: strict types for options, tasks, results, agent outputs.
- REST API (server)
  - `GET /v1/health` -> { status, version }
  - `POST /v1/run/single` -> run brownfield task and return result
  - `POST /v1/run/prd` -> run PRD loop (sequential or parallel) and return summary
  - `POST /v1/config/init` -> init .ralphy config
  - `GET /v1/config` -> show config
  - `POST /v1/config/rules` -> add rule
  - `GET /v1/tasks/next` -> preview next task (from PRD source)
  - `POST /v1/tasks/complete` -> mark task complete (markdown/yaml/github)
- Agent execution
  - External CLIs invoked with Bun.spawn, preserving prompts and environment variables (notably OPENCODE_PERMISSION).
  - Parsing logic preserved for agent outputs (Codex last-message file, OpenCode JSON streams, Cursor duration, etc.).

Sprint plan (atomic, testable, demoable)

Sprint 1: CLI scaffold + minimal server
- [x] Task 1: Create Bun CLI entrypoint with yargs parsing, help/version output, and option schema parity (no behavior yet).
- [x] Task 2: Add server bootstrap (Bun.serve) with `/v1/health` and `/v1/version`.
- [x] Task 3: Implement CLI -> server request dispatch (spawns server, waits for ready, calls endpoint, shuts down).
- [x] Task 4: Add types for CLI options and server requests/responses.
- Demo/verify: `bun run src/cli.ts --help`, `bun run src/cli.ts --version`, `bun run src/cli.ts --dry-run` hits health endpoint.

Sprint 2: Config + init flows
- [x] Task 1: Implement `.ralphy/` init logic (project detection, config.yaml + progress.txt creation, overwrite prompt).
- [x] Task 2: Implement config read/show and `--add-rule` update with YAML manipulation.
- [x] Task 3: Wire CLI flags (`--init`, `--config`, `--add-rule`) to server endpoints.
- [x] Task 4: Add unit tests for config init/show/add-rule.
- Demo/verify: run `--init`, inspect `.ralphy/config.yaml`, `--config`, `--add-rule`.

Sprint 3: PRD sources + task model
- [x] Task 1: Implement markdown PRD parsing (`- [ ]` and `- [x]`), task completion updates with safe escaping.
- [x] Task 2: Implement YAML task parsing (`tasks[]`, `completed`, `parallel_group`) and completion updates.
- [x] Task 3: Implement GitHub issues source using `gh issue list/view/close` with label filter.
- [x] Task 4: Add unified task source interface + `GET /v1/tasks/next` and `POST /v1/tasks/complete`.
- [x] Task 5: Add tests for all task sources with fixtures.
- Demo/verify: `--prd`, `--yaml`, `--github` + `tasks/next` and completion updates.

Sprint 4: Prompt builders + agent runners (single-task)
- [x] Task 1: Build prompt construction parity (config rules/boundaries/project context, progress file, test/lint flags, commit instructions, completion tag).
- [x] Task 2: Implement agent runner adapters for Claude/OpenCode/Cursor/Codex/Qwen/Droid via Bun.spawn.
- [x] Task 3: Implement single-task (brownfield) run flow, retries, and result parsing.
- [x] Task 4: Add tests for prompt assembly and command construction (snapshot style).
- Demo/verify: run positional task with each engine flag in dry-run and real modes.

Sprint 5: PRD sequential loop
- [x] Task 1: Implement requirement checks (git repo, dependencies, PRD presence).
- [x] Task 2: Implement sequential loop: select next task, run agent, update PRD, track retries and max-iterations.
- [x] Task 3: Implement progress logging + cost/token accounting.
- [x] Task 4: Add tests for loop control paths (max-iterations, no tasks, retry exhaustion).
- Demo/verify: run PRD loop against markdown/YAML sources with `--max-iterations`.

Sprint 6: Git workflows + PR creation
- [x] Task 1: Implement branch-per-task flow (stash handling, slugify, branch naming).
- [x] Task 2: Implement `--create-pr` + `--draft-pr` using `gh`.
- [x] Task 3: Add tests for branch naming, command construction, and dry-run flows.
- Demo/verify: run PRD loop with `--branch-per-task` and `--create-pr` in a test repo.

Sprint 7: Parallel mode + worktrees
- [x] Task 1: Implement worktree creation per task group with isolated dirs and copy PRD.
- [x] Task 2: Implement parallel execution pooling with `--max-parallel`.
- [x] Task 3: Implement integration branch merges and conflict resolution flow (AI-assisted) parity.
- [x] Task 4: Cleanup/trap handling for worktrees and background processes.
- [x] Task 5: Add tests for worktree lifecycle and merge command construction.
- Demo/verify: run YAML tasks with `parallel_group` using `--parallel`.

Sprint 8: Packaging + end-to-end
- [ ] Task 1: Add compiled binary build script using `bun build --compile`.
- [ ] Task 2: Add e2e smoke tests (help/version, init, single-task dry-run, PRD dry-run).
- [ ] Task 3: Add minimal release notes or usage doc (if needed).
- Demo/verify: build binary and run `./ralphy --help`.

Files to add/modify (planned)
- `src/cli.ts`
- `src/server/index.ts`
- `src/shared/types.ts`
- `src/core/config.ts`
- `src/core/tasks/markdown.ts`
- `src/core/tasks/yaml.ts`
- `src/core/tasks/github.ts`
- `src/core/prompts.ts`
- `src/core/agents/*.ts`
- `src/core/git/*.ts`
- `src/core/parallel/*.ts`
- `tests/**/*.test.ts`

Verification (final)
- `bun test`
- `bun run src/cli.ts --help`
- `bun run src/cli.ts --version`
- `bun run src/cli.ts --init`
- `bun run src/cli.ts "do x" --dry-run`
- `bun run src/cli.ts --prd PRD.md --max-iterations 1 --dry-run`
- `bun build --compile src/cli.ts`
