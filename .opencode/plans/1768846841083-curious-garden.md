# Ralphy.sh parity plan

## Scope
Identify and close behavioral gaps between `ralphy.sh` and the Bun app in `src/` + `tests/`. Add missing behaviors only; do not remove Bun expansions (e.g., broader markdown parsing).

## Known deviations to cover
- Default PRD run: no-arg run should auto-load `PRD.md` and run with defaults (already noted by user).
- CLI flags: `--fast` parsed but not applied; `--dry-run` only hits `/v1/health`; `--max-iterations 0` stops immediately instead of unlimited.
- Preflight checks: Bun lacks CLI checks (`gh`, `yq`, AI CLIs), does not enforce github repo/label requirements, and does not ensure `.ralphy/progress.txt` exists.
- Config UX: `--init` lacks overwrite prompt + detected summary/next steps; `--config` returns raw YAML instead of formatted view.
- Prompt parity: missing `@PRD.md/@tasks.yaml` in prompt context; GitHub issue body not injected.
- GitHub tasks: tasks identified by title only; should be `number:title` and completed by issue number; missing issue body retrieval.
- Task truncation: `get_next_task` truncates to 50 chars in `ralphy.sh`; Bun uses full text.
- Branch-per-task: no git pull, no fallback to existing branch, different stash semantics.
- Create PR: no auto-push and weaker body/title flow.
- Parallel mode: Bun lacks task-level parallel orchestration + integration branch merge flow.
- Worktree creation/cleanup: behavior diverges from script (naming/location, pruning, and dirty-worktree preservation).

## Sprint plan (each sprint demoable)

### Sprint 1: CLI + PRD default parity
- [x] Implement no-arg PRD run parity so `ralphy` defaults to `PRD.md` and builds the same prompt as `ralphy.sh` (`src/cli.ts`, `src/core/prd.ts`, `src/core/prompts.ts`).
- [x] Wire `--fast` to set `skipTests=true` and `skipLint=true` for both PRD and single-task runs (`src/cli.ts`, `src/shared/types.ts`).
- [x] Align `--dry-run` to return generated prompt (single-task + PRD) instead of only `/v1/health` (`src/cli.ts`, `src/core/prd.ts`, `src/core/single.ts`).
- [x] Match `--max-iterations 0` => unlimited behavior (`src/core/prd.ts`).
- [x] Add/adjust tests for CLI args and PRD run defaults (`tests/cli.test.ts`, `tests/prd.test.ts`, `tests/prompts.test.ts`).

### Sprint 2: Preflight checks + config UX parity
- [ ] Implement full preflight checks: `git` repo, required CLI presence per engine, `jq`/`yq`/`gh` rules, `--github` repo requirement (`src/core/prd.ts`, `src/core/single.ts`).
- [ ] Ensure `.ralphy/progress.txt` auto-creation (matching `ralphy.sh`) for both PRD and single-task (`src/core/progress.ts` or shared helper).
- [ ] Add `--init` overwrite prompt + detected-summary output + next-steps output (`src/core/config.ts`, `src/server/index.ts`).
- [ ] Format `--config` output to match `ralphy.sh` sections (Project/Commands/Rules/Boundaries) (`src/server/index.ts`, `src/core/config.ts`).
- [ ] Add/adjust tests for config UX and preflight validation (`tests/config.test.ts`, `tests/prd.test.ts`, `tests/single.test.ts`).

### Sprint 3: Prompt + GitHub task parity
- [ ] Inject `@PRD.md`/`@tasks.yaml` references in prompts for PRD mode and add GitHub issue body context when source is github (`src/core/prompts.ts`, `src/core/prd.ts`).
- [ ] Change GitHub task identity to `number:title` and complete by issue number; keep title in display text if desired (`src/core/tasks/github.ts`, `src/core/tasks/source.ts`).
- [ ] Add `gh issue view` body retrieval and plumb into prompt context (`src/core/tasks/github.ts`, `src/core/prd.ts`).
- [ ] Implement 50-char truncation for `get_next_task` (markdown/yaml/github) while preserving full text for completion as needed (`src/core/tasks/source.ts`).
- [ ] Update fixtures/snapshots/tests for GitHub task identity and prompt contents (`tests/github.test.ts`, `tests/tasks-source.test.ts`, `tests/prompts.test.ts`).

### Sprint 4: Branch workflow + PR creation parity
- [ ] Align branch-per-task behavior: stash message, pull base branch, reuse existing branch if present; keep Bun safety (unique branch) as fallback if name conflicts (`src/core/git/branch.ts`).
- [ ] Implement PR creation flow: push branch before PR, use base/head/title/body, draft flag (`src/core/git/pr.ts`, `src/core/prd.ts`, `src/core/single.ts`).
- [ ] Update tests for branch + PR behavior (`tests/branch.test.ts`, `tests/pr.test.ts`).

### Sprint 5: Parallel orchestration parity
- [ ] Implement task-level parallel execution with grouping (`parallel_group`) and integration branches; enforce github source unsupported in parallel (match script) (`src/core/prd.ts`, new `src/core/parallel/runner.ts`).
- [ ] Create worktree lifecycle to match script: naming, base dir, pruning, copying PRD/progress, and preserve dirty worktrees (`src/core/parallel/worktrees.ts`).
- [ ] Add/adjust parallel workflow tests (`tests/worktrees.test.ts`, `tests/agents-runner.test.ts`, `tests/prd.test.ts`).

## Verification
- Run targeted unit tests per sprint: `bun test tests/cli.test.ts`, `bun test tests/prd.test.ts`, `bun test tests/config.test.ts`, `bun test tests/github.test.ts`, `bun test tests/prompts.test.ts`, `bun test tests/branch.test.ts`, `bun test tests/pr.test.ts`, `bun test tests/worktrees.test.ts`.
- Manual smoke: run `bun run src/cli.ts` with `--help`, `--init`, `--config`, `--dry-run`, no args with `PRD.md`, and github mode (`--github owner/repo`).
